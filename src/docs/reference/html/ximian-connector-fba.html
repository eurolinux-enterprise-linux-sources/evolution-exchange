<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Exchange 2003 Forms-Based Authentication</title>
<meta name="generator" content="DocBook XSL Stylesheets V1.74.0">
<link rel="home" href="index.html" title="Evolution Connector for Microsoft Exchange Programmer’s Reference Manual">
<link rel="up" href="ch02.html" title="Implementation of Connector Features">
<link rel="prev" href="ximian-connector-favorites.html" title="Favorite Public Folders">
<link rel="next" href="ximian-connector-freebusy.html" title="Free/Busy Searches">
<meta name="generator" content="GTK-Doc V1.14 (XML mode)">
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table class="navigation" id="top" width="100%" summary="Navigation header" cellpadding="2" cellspacing="2"><tr valign="middle">
<td><a accesskey="p" href="ximian-connector-favorites.html"><img src="left.png" width="24" height="24" border="0" alt="Prev"></a></td>
<td><a accesskey="u" href="ch02.html"><img src="up.png" width="24" height="24" border="0" alt="Up"></a></td>
<td><a accesskey="h" href="index.html"><img src="home.png" width="24" height="24" border="0" alt="Home"></a></td>
<th width="100%" align="center">Evolution Connector for Microsoft Exchange Programmer’s Reference Manual</th>
<td><a accesskey="n" href="ximian-connector-freebusy.html"><img src="right.png" width="24" height="24" border="0" alt="Next"></a></td>
</tr></table>
<div class="refentry" lang="en">
<a name="ximian-connector-fba"></a><div class="titlepage"></div>
<div class="refnamediv"><table width="100%"><tr>
<td valign="top">
<h2><span class="refentrytitle"><span class="application">Exchange 2003</span> Forms-Based Authentication</span></h2>
<p></p>
</td>
<td valign="top" align="right"></td>
</tr></table></div>
<p>
<span class="application">Exchange 2003</span> introduced "forms-based
authentication" for <span class="application">OWA</span>, which lets the
administrator configure <span class="application">OWA</span> to present an
HTML form to the user to type his username and password into instead
of using HTTP authentication. This main benefit of this is that it
gives the administrator more control over how and when the
authentication expires. It's annoying for us though. If forms-based
auth is turned on, then HTTP auth just won't work. You have to play
the forms game.
</p>
<p>
If forms-based auth is turned on, then SSL must also be required, and
non-https requests will get "<code class="literal"><span class="errorcode">403</span>
<span class="errorname">Forbidden</span></code>".
</p>
<p>
<span class="command"><strong>GET</strong></span> requests under <code class="uri">/exchange</code> will be
redirected to
<code class="uri">/exchweb/bin/auth/owalogon.asp?url=<em class="replaceable"><code>original-url</code></em>&amp;reason=0</code>.
All other HTTP/WebDAV requests will get a
"<code class="literal"><span class="errorcode">440</span> <span class="errorname">Login
Timeout</span></code>". (This is not a real IANA-registered
HTTP error code.)
</p>
<p>
Trying to <span class="command"><strong>GET</strong></span> <code class="uri">owalogon.asp</code> with
"<code class="literal">Translate: F</code>" will return
"<code class="literal"><span class="errorcode">403</span>
<span class="errorname">Forbidden</span></code>".
</p>
<p>
The page returned by <code class="uri">owalogon.asp</code> is slightly different for
<span class="application">IE</span> and non-<span class="application">IE</span>.
Either way it contains a form with at least the following fields:
</p>
<div class="variablelist"><table border="0">
<col align="left" valign="top">
<tbody>
<tr>
<td><p><span class="term"><code class="literal">destination</code> (hidden)</span></p></td>
<td><p>the original URL that redirected us
	here</p></td>
</tr>
<tr>
<td><p><span class="term"><code class="literal">flags</code> (hidden)</span></p></td>
<td><p>options bitfield, as described
	below</p></td>
</tr>
<tr>
<td><p><span class="term"><code class="literal">username</code></span></p></td>
<td><p>the username entry</p></td>
</tr>
<tr>
<td><p><span class="term"><code class="literal">password</code></span></p></td>
<td><p>the password entry</p></td>
</tr>
<tr>
<td><p><span class="term"><code class="literal">trusted</code></span></p></td>
<td><p>whether this is a public or private
	computer</p></td>
</tr>
</tbody>
</table></div>
<p>
The "<code class="literal">private</code>" value for
"<code class="literal">trusted</code>" is <code class="constant">4</code>, and we pass
that, so that we get the longer credentials timeout time. (24 hours by
default). You also have to pass <code class="constant">4</code> for
"<code class="literal">flags</code>" to indicate this. (The
"<code class="literal">1</code>" bit in flags indicate that you want to use the
non-<span class="application">IE</span> version of
<span class="application">OWA</span> even if you are on
<span class="application">IE</span>. We don't pass that option.)
</p>
<p>
We then <span class="command"><strong>POST</strong></span> the form with the user's username and
password:
</p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1
2
3
4
5
6</pre></td>
        <td class="listing_code"><pre class="programlisting">POST /exchweb/bin/auth/owaauth.dll HTTP/<span class="number">1.1</span>
<span class="keyword">Host</span>: ex2k3.xcs.ximian.com
Content-Type: application/x-www-form-urlencoded
Content-Length: &lt;em <span class="type">class</span>=<span class="number">&quot;replaceable&quot;</span>&gt;&lt;code&gt;len&lt;/code&gt;&lt;/em&gt;

destination=https%3A%<span class="number">2F</span>%<span class="number">2F</span>ex2k3.xcs.ximian.com%<span class="number">2F</span>exchange%<span class="number">2F</span>&amp;flags=<span class="number">0</span>&amp;username=&lt;em <span class="type">class</span>=<span class="number">&quot;replaceable&quot;</span>&gt;&lt;code&gt;username&lt;/code&gt;&lt;/em&gt;&amp;password=&lt;em <span class="type">class</span>=<span class="number">&quot;replaceable&quot;</span>&gt;&lt;code&gt;password&lt;/code&gt;&lt;/em&gt;&amp;SubmitCreds=Log+On&amp;trusted=<span class="number">4</span></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
To which the server responds:
</p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1
2
3
4
5
6
7
8</pre></td>
        <td class="listing_code"><pre class="programlisting">HTTP/<span class="number">1.1</span> <span class="number">302</span> Moved Temporarily
<span class="keyword">Server</span>: Microsoft-IIS/<span class="number">5.0</span>
<span class="keyword">Date</span>: Thu, <span class="number">24</span> Jul <span class="number">2003</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">33</span> GMT
X-Powered-By: ASP.NET
<span class="keyword">Location</span>: https:<span class="comment">//ex2k3.xcs.ximian.com/exchange/</span>
Set-Cookie: sessionid=fbb50caf-381a-<span class="number">4f</span>85-<span class="number">9582</span>-a7a902b4561f,<span class="number">0x409</span>; path=/
Set-Cookie: cadata=<span class="number">&quot;2,8JOrhvROIJykiSTShG6Ujrigo+a5XQgEbws7tq3//37QERyFwWDoV7xw6DG+Awlm&quot;</span>; HttpOnly; secure; path=/
Content-Length: <span class="number">0</span></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
("<code class="literal">HttpOnly</code>" is a Microsoft extension to the Cookie
protocol, which means that the cookie should not be visible to
Javascript/VBScript, etc. "<code class="literal">secure</code>" means that you
should only send it over https, and "<code class="literal">path=/</code>" means
it's good for any path on this server.)
</p>
<p>
Now you have to make another request to find out if the cookie is any
good. This request (and all further requests) should include the two
cookies:
</p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1
2</pre></td>
        <td class="listing_code"><pre class="programlisting"><span class="keyword">Cookie</span>: sessionid=fbb50caf-381a-<span class="number">4f</span>85-<span class="number">9582</span>-a7a902b4561f,<span class="number">0x409</span>;
        cadata=<span class="number">&quot;2,8JOrhvROIJykiSTShG6Ujrigo+a5XQgEbws7tq3//37QERyFwWDoV7xw6DG+Awlm&quot;</span></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
If you do an <span class="application">OWA</span> <span class="command"><strong>GET</strong></span> (a
<span class="command"><strong>GET</strong></span> without "<code class="literal">Translate: F</code>"),
failure will be indicated by a "<code class="literal"><span class="errorcode">200</span>
<span class="errorname">OK</span></code>" response containing the login
form again. If you do any other request, failure is indicated by a
"<code class="literal"><span class="errorcode">440</span> <span class="errorname">Login
Timeout</span></code>" cancelling the cookie:
</p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1
2
3
4</pre></td>
        <td class="listing_code"><pre class="programlisting"><span class="number">440</span> Login Timeout
Set-Cookie: sessionid=; path=/; expires=Thu, <span class="preproc">0</span><span class="number">1</span>-Jan-<span class="number">1970</span> <span class="preproc">0</span><span class="number">0</span>:<span class="preproc">0</span><span class="number">0</span>:<span class="preproc">0</span><span class="number">0</span> GMT
Set-Cookie: cadata=; path=/; expires=Thu, <span class="preproc">0</span><span class="number">1</span>-Jan-<span class="number">1970</span> <span class="preproc">0</span><span class="number">0</span>:<span class="preproc">0</span><span class="number">0</span>:<span class="preproc">0</span><span class="number">0</span> GMT
<span class="keyword">Connection</span>: close</pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
Eventually, when the cookie does expire, you will get a
"<code class="literal"><span class="errorcode">440</span> <span class="errorname">Login
Timeout</span></code>" as above, and have to reauthenticate to
get a new cookie.
</p>
</div>
<div class="footer">
<hr>
          Generated by GTK-Doc V1.14</div>
</body>
</html>